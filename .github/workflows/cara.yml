name: Build TrixieOS (Buildroot + LXQt)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install deps
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          xorriso grub-pc-bin grub-efi-amd64-bin \
          wget git cpio rsync unzip python3

    - name: Clone Buildroot
      run: |
        git clone https://github.com/buildroot/buildroot.git
        cd buildroot
        git checkout 2024.02

    - name: Configure Buildroot (TrixieOS)
      run: |
        cd buildroot
        make defconfig

        cat << 'EOF' >> .config
        BR2_x86_64=y
        BR2_TOOLCHAIN_BUILDROOT_GLIBC=y

        BR2_LINUX_KERNEL=y
        BR2_LINUX_KERNEL_CUSTOM_VERSION=y
        BR2_LINUX_KERNEL_CUSTOM_VERSION_VALUE="6.6.8"
        BR2_LINUX_KERNEL_USE_CUSTOM_CONFIG=y
        BR2_LINUX_KERNEL_DEFCONFIG="x86_64"

        BR2_INIT_BUSYBOX=y

        BR2_PACKAGE_XORG7=y
        BR2_PACKAGE_XSERVER_XORG_SERVER=y
        BR2_PACKAGE_XINIT=y
        BR2_PACKAGE_LXQT=y
        BR2_PACKAGE_OPENBOX=y
        BR2_PACKAGE_LIGHTDM=y

        BR2_PACKAGE_GRUB2=y

        BR2_TARGET_GENERIC_HOSTNAME="TrixieOS"
        BR2_TARGET_GENERIC_ISSUE="TrixieOS - ProjectA tarafından yapıldı"

        BR2_TARGET_ROOTFS_ISO9660=y
        BR2_TARGET_ROOTFS_ISO9660_VOLUME_ID="TrixieOS"
        EOF

        make olddefconfig

    - name: Build TrixieOS
      run: |
        cd buildroot
        make -j$(nproc)

    - name: Rename ISO
      run: |
        cd buildroot/output/images
        mv rootfs.iso9660 TrixieOS.iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOS-ISO
        path: buildroot/output/images/TrixieOS.iso
