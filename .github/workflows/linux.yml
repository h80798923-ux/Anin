name: Build TrixieOS (Buildroot + LXQt)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install deps
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential git wget cpio unzip rsync \
          bc bison flex libssl-dev libelf-dev \
          xorriso grub-pc-bin grub-efi-amd64-bin

    - name: Clone Buildroot
      run: |
        git clone https://github.com/buildroot/buildroot.git
        cd buildroot
        git checkout 2024.02

    - name: Configure Buildroot
      run: |
        cd buildroot
        make qemu_x86_64_defconfig

        ./scripts/config \
          --enable BR2_x86_64 \
          --enable BR2_TOOLCHAIN_BUILDROOT_GLIBC \
          --enable BR2_LINUX_KERNEL \
          --enable BR2_LINUX_KERNEL_CUSTOM_VERSION \
          --set-str BR2_LINUX_KERNEL_CUSTOM_VERSION_VALUE "6.6.8" \
          --enable BR2_PACKAGE_XORG7 \
          --enable BR2_PACKAGE_LXQT \
          --enable BR2_PACKAGE_MATCHBOX \
          --enable BR2_TARGET_ROOTFS_SQUASHFS

        make olddefconfig

    - name: Build TrixieOS
      run: |
        cd buildroot
        make -j$(nproc)

    - name: Create ISO
      run: |
        mkdir iso
        cp buildroot/output/images/bzImage iso/vmlinuz
        cp buildroot/output/images/rootfs.squashfs iso/rootfs.squashfs

        echo 'set timeout=3
        menuentry "TrixieOS (ProjectA tarafından yapıldı)" {
          linux /vmlinuz quiet
        }' > iso/grub.cfg

        grub-mkrescue -o TrixieOS.iso iso

    - uses: actions/upload-artifact@v4
      with:
        name: TrixieOS
        path: TrixieOS.iso
